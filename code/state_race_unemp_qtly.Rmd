---
title: "state_race_unemp_qtly"
output: html_document
---

```{r Libraries}
library(tidyverse)
library(epiextractr)
library(epidatatools)
library(blsAPI)
library(here)
library(readxl)
library(openxlsx)
library(data.table)
library(zoo)
library(lubridate)
```

Select reference and current periods. Curr
```{r Select quarters}
ref_qtr1 = '2019 Q4'
ref_qtr2 = '2020 Q1'

prev_qtr= '2021 Q3'
cur_qtr = '2021 Q4'
```

BLS API function to load LAUS data

```{r BLS API function}

bls_key <- Sys.getenv("BLS_REG_KEY")
series_ids <- fread(here('input/seriesid.csv'))
statedata <- series_ids$series_id

# This is where our state unemployment data lives
rawsource <- "https://download.bls.gov/pub/time.series/la/"

#function to retrieve data from BLS
#max number of years is 20 per query, max seriesids is 50 per query, max queries per day is 500 for registered users.
get_bls_data <- function(codes) {
  
  payload1 <- list('seriesid' = codes[1:50], 'startyear' = '2006', 'endyear' = '2021', 'registrationkey' = bls_key)
  payload2 <- list('seriesid' = codes[51:52], 'startyear' = '2006', 'endyear' = '2021', 'registrationkey' = bls_key)

  df1 <- blsAPI(payload1, api_version = 2, return_data_frame = TRUE)
  df2 <- blsAPI(payload2, api_version = 2, return_data_frame = TRUE)
  
  rbind(df1, df2)
}

```

Load LAUS data, and state labels here

```{r Load LAUS, state labels}
state_labels<- read_csv(here('input/statefips_labels.csv'), col_names = TRUE)

# Clean and format bls data
laus <- get_bls_data(statedata) %>% 
  mutate(urate = as.numeric(value)/100, .keep="unused") %>% #turn LAUS urates into percentages
  full_join(series_ids, by= c('seriesID' = 'series_id')) %>%
  mutate(month = as.numeric(substr(period,2,3))) %>% #create standard date variable
  mutate(date = as.Date(paste(year, month, 1, sep = "-"), "%Y-%m-%d")) %>% 
  mutate(qtr=as.yearqtr(date)) %>%  #create a qtr variable 
  arrange(year, month, state) %>% 
  left_join(state_labels)

reference_qtr_laus <- laus %>% 
filter(qtr==ref_qtr1) %>% 
  group_by(st_abbr) %>%
  summarize(laus_qtr_unemp = mean(urate))

current_qtr_laus <- laus %>% 
  filter(qtr==cur_qtr) %>% 
  group_by(st_abbr) %>%
  summarize(laus_qtr_unemp = mean(urate)) 

```


Load CPS data using extractr, and estimate 6-month state averages
```{r Load CPS}
cps <-load_basic(2016:2021, age, female, wbhao, statefips, unemp, month, basicwgt, lfstat, age, year) %>% 
  mutate(date = as.Date(paste(year, month, 1, sep = "-"), "%Y-%m-%d")) %>% 
  mutate(qtr=as.yearqtr(date)) %>%  #create quarter variable
  filter(age>=16, lfstat!=3) %>% 
  left_join(state_labels) %>% 
  mutate(across(wbhao|female, ~ as.character(haven::as_factor(.x))))
```

```{r CPS state estimates}
#### Estimate state unemp rates using 2 quarters of data ###
## Reference quarter + previous (2019 Q4 & 2020 Q1) rolling average ##
state_urates_ref <- cps %>% 
  filter(qtr==ref_qtr1 | qtr == ref_qtr2) %>% 
  group_by(st_abbr) %>% 
  summarize(st_urate_6mos = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE))

## Current quarter + previous qtr ##
state_urates <- cps %>% 
  filter(qtr==prev_qtr | qtr==cur_qtr) %>% 
  group_by(st_abbr) %>% 
  summarize(st_urate_6mos = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE))
```


```{r CPS national estimates}
#CPS estimate of US unemp
us_current <- cps %>% 
  filter(qtr==prev_qtr | qtr==cur_qtr) %>% 
  mutate(overall= paste('US','-','All','-','All'),
         gender = paste('US','-','All','-',female),
         race = paste('US','-',wbhao,'-','All'),
         genderXrace = paste('US','-',wbhao,'-',female)) %>% 
  summarize_groups(overall|race|gender|genderXrace,
                   subgroup_urate = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE),
                   n=n()) %>% 
  separate(group_value, c('st_abbr','wbhao','gender')) %>% #creates st_abbr, wbho, gender variables
  mutate(st_urate_6mos = subgroup_urate[1],
         st_abbr = 'US',
         ratio = subgroup_urate/st_urate_6mos)

us_ref <- cps %>% 
  filter(qtr=='2019 Q4'| qtr=='2020 Q1') %>% 
  mutate(overall= paste('US','-','All','-','All'),
         gender = paste('US','-','All','-',female),
         race = paste('US','-',wbhao,'-','All'),
         genderXrace = paste('US','-',wbhao,'-',female)) %>% 
  summarize_groups(overall|race|gender|genderXrace,
                   subgroup_urate = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE),
                   n=n()) %>% 
  separate(group_value, c('st_abbr','wbhao','gender')) %>% 
  mutate(st_urate_6mos = subgroup_urate[1],
         st_abbr = 'US',
         ratio = subgroup_urate/st_urate_6mos)
  
```

```{r Merge CPS + LAUS data}

#### Merge CPS and BLS LAUS estimates ####

current_wrangle <- cps %>% 
  filter(qtr==prev_qtr | qtr== cur_qtr) %>% 
  mutate(stateXrace = paste(st_abbr,'-', wbhao,'-','All'),
         stateXgender = paste(st_abbr,'-','All','-',female),
         stXraceXgender = paste(st_abbr,'-',wbhao,'-',female)) %>% 
  summarize_groups(st_abbr|stateXrace|stXraceXgender|stateXgender,
                   subgroup_urate = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE),
                   n=n()) %>% 
  separate(group_value, c('st_abbr','wbhao','gender')) %>% #creates st_abbr, wbho, gender variables
  left_join(state_urates) %>% #merge statefips labels by st_abbr to get fips codes and CPS estimated urates
  mutate(ratio = subgroup_urate/st_urate_6mos) %>% #get ratio of (6-month state avg:subgroup) unemployment rate
  arrange(st_abbr, -n) %>% 
  bind_rows(us_current) %>% #bind US overall results
  left_join(current_qtr_laus) %>% #merge quarterly laus unemp estimates
  mutate(qtr_st_urate_by_reg = ratio * laus_qtr_unemp,
         moe95 = 1.96*(sqrt(subgroup_urate*(1-subgroup_urate)/n))) %>% 
  mutate(suppressed_urates = replace(qtr_st_urate_by_reg, n<=700, NA),
         alt_sup_urates = replace(qtr_st_urate_by_reg, moe95>=.02 | moe95>=qtr_st_urate_by_reg, NA)) %>%  # replace all values with <700 obs with NA
  left_join(state_labels) %>% 
  select(state, st_abbr, gender, wbhao, n, subgroup_urate, moe95,
         st_urate_6mos, ratio, laus_qtr_unemp, qtr_st_urate_by_reg, suppressed_urates, alt_sup_urates) %>% # Clean our data up
    mutate(wbhao = replace_na(wbhao, 'All'),
           gender = replace_na(gender, 'All')) %>% 
  filter(wbhao!='Other')


reference_wrangle <- cps %>% 
  filter(qtr==ref_qtr1 | qtr== ref_qtr2) %>% 
  mutate(stateXrace = paste(st_abbr,'-', wbhao,'-','All'),
         stateXgender = paste(st_abbr,'-','All','-',female),
         stXraceXgender = paste(st_abbr,'-',wbhao,'-',female)) %>% 
  summarize_groups(st_abbr|stateXrace|stXraceXgender|stateXgender,
                   subgroup_urate = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE),
                   n=n()) %>% 
  separate(group_value, c('st_abbr','wbhao','gender')) %>% #creates st_abbr, wbho, gender variables
  left_join(state_urates_ref) %>% #merge statefips labels by st_abbr to get fips codes and CPS estimated urates
  mutate(ratio = subgroup_urate/st_urate_6mos) %>% #get ratio of (6-month state avg:subgroup) unemployment rate
  arrange(st_abbr, -n) %>% 
  bind_rows(us_ref) %>% #bind US overall results
  left_join(reference_qtr_laus) %>% #merge quarterly laus unemp estimates
  mutate(qtr_st_urate_by_reg = ratio * laus_qtr_unemp,
         moe95 = 1.96*(sqrt(subgroup_urate*(1-subgroup_urate)/n))) %>% 
  mutate(suppressed_urates = replace(qtr_st_urate_by_reg, n<=700, NA)) %>%  # replace all values with <700 obs with NA
  left_join(state_labels) %>% 
  select(state, st_abbr, gender, wbhao, n, subgroup_urate, moe95,
         st_urate_6mos, ratio, laus_qtr_unemp, qtr_st_urate_by_reg, suppressed_urates) %>% # Clean our data up
    mutate(wbhao = replace_na(wbhao, 'All'),
           gender = replace_na(gender, 'All')) %>% 
  filter(wbhao!='Other')

```


```{r}
# Table of monthly urate by state
laus_monthly <- laus %>% 
  select(state, date, urate) %>%
  pivot_wider(id_cols = state, names_from=date, values_from=urate)

# Table of average quarterly unemployment by state
laus_qtrly <- laus %>% 
  select(state, qtr, urate) %>% 
  group_by(state, qtr) %>% 
  summarize(qtr_urate = mean(urate)) %>% 
  pivot_wider(id_cols = state, names_from=qtr, values_from=qtr_urate)
```

Supplemental files

```{r}

cps_monthly <- cps %>% 
  group_by(st_abbr, date) %>% 
  summarize(urate = weighted.mean(unemp, w=basicwgt/6)) %>%
  pivot_wider(id_cols = st_abbr, names_from=date, values_from = urate)

cps_qtrly <- cps %>% 
  group_by(st_abbr, qtr) %>% 
  summarize(urate = weighted.mean(unemp, w=basicwgt/6)) %>%
  pivot_wider(id_cols = st_abbr, names_from=qtr, values_from = urate) 

current_qtr <- current_wrangle %>% 
  filter(gender=='All') %>% 
  pivot_wider(id_cols=state, names_from = wbhao, values_from = suppressed_urates) %>% 
  mutate(bw_ratio = Black/White,
         hw_ratio = Hispanic/White)
  
reference_qtr <- reference_wrangle %>% 
  filter(gender=='All') %>% 
  pivot_wider(id_cols=state, names_from = wbhao, values_from = suppressed_urates) %>% 
  mutate(bw_ratio = Black/White,
         hw_ratio = Hispanic/White)
```

```{r}
EARN_staterace_umemp <- createWorkbook()

addWorksheet(EARN_staterace_umemp, sheetName = "2020 Q1 raw")
addWorksheet(EARN_staterace_umemp, sheetName = "2021 Q3 raw")

addWorksheet(EARN_staterace_umemp, sheetName = "2020 Q1 final output")
addWorksheet(EARN_staterace_umemp, sheetName = "2021 Q3 final output")

addWorksheet(EARN_staterace_umemp, sheetName = "LAUS Monthly")
addWorksheet(EARN_staterace_umemp, sheetName = "LAUS Qtrly")

addWorksheet(EARN_staterace_umemp, sheetName = "CPS Monthly")
addWorksheet(EARN_staterace_umemp, sheetName = "CPS Qtrly")


writeData(EARN_staterace_umemp, current_wrangle, sheet = "2021 Q3 raw",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, reference_wrangle, sheet = "2020 Q1 raw",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, reference_qtr, sheet = "2020 Q1 final output",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, current_qtr, sheet = "2021 Q3 final output",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, laus_monthly, sheet = "LAUS Monthly",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, laus_qtrly, sheet = "LAUS Qtrly",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, cps_qtrly, sheet = "CPS Qtrly",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, cps_qtrly , sheet = "CPS Monthly",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)

saveWorkbook(EARN_staterace_umemp, here("/data/EARN_staterace_2021Q3.xlsx"), overwrite = TRUE)
```




