---
title: "state_race_unemp_qtly"
author: Daniel Perez, EPI
output: html_document
---

```{r Libraries}
library(tidyverse)
library(epiextractr)
library(epidatatools)
library(blsAPI)
library(here)
library(readxl)
library(openxlsx)
library(data.table)
library(zoo)
library(lubridate)
library(janitor)
```

```{r BLS API function}

#BLS API keys are available at https://www.bls.gov/developers/
bls_key <- Sys.getenv("BLS_REG_KEY")
series_ids <- fread(here('input/seriesid.csv'))
statedata <- series_ids$series_id

# This is where our state unemployment data lives
rawsource <- "https://download.bls.gov/pub/time.series/la/"

#function to retrieve data from BLS
#max number of years is 20 per query, max seriesids is 50 per query, max queries per day is 500 for registered users.
get_bls_data <- function(codes) {
  
  payload1 <- list('seriesid' = codes[1:50], 'startyear' = '2006', 'endyear' = '2022', 'registrationkey' = bls_key)
  payload2 <- list('seriesid' = codes[51:52], 'startyear' = '2006', 'endyear' = '2022', 'registrationkey' = bls_key)

  df1 <- blsAPI(payload1, api_version = 2, return_data_frame = TRUE)
  df2 <- blsAPI(payload2, api_version = 2, return_data_frame = TRUE)
  
  rbind(df1, df2)
}

```

Load LAUS data, and state labels here

```{r Load LAUS via BLS API}
#Optional -- load state labels
state_labels<- read_csv(here('input/statefips_labels.csv'), col_names = TRUE)

# Clean and format bls data
laus <- get_bls_data(statedata) %>% 
  #convert LAUS urates into percentages
  mutate(urate = as.numeric(value)/100, .keep="unused") %>% 
  #merge state names by series ID
  full_join(series_ids, by= c('seriesID' = 'series_id')) %>%
  #create standard date variable
  mutate(month = as.numeric(substr(period,2,3))) %>% 
  mutate(date = as.Date(paste(year, month, 1, sep = "-"), "%Y-%m-%d")) %>% 
  #create quarterly variable 
  mutate(qtr=as.yearqtr(date)) %>% 
  arrange(year, month, state) %>% 
  #merge state labels (optional)
  left_join(state_labels)
```

```{r Load CPS via EPI extractr}

#Use EPI extractr to load CPS Basic. See more at https://github.com/Economic/epiextractr
cps <-load_basic(2016:2022, year, month, basicwgt, age, female, wbhao, statefips, unemp, lfstat) %>% 
  filter(age>=16, lfstat!=3) %>% 
  mutate(date = as.Date(paste(year, month, 1, sep = "-"), "%Y-%m-%d")) %>% 
  #create quarterly date periods
  mutate(qtr=as.yearqtr(date)) %>%  
  #merge optional labels
  left_join(state_labels) %>% 
  mutate(across(wbhao|female, ~ as.character(haven::as_factor(.x))))
```

```{r Quarters being analyzed}
#List of all quarters in data sample
qtr_list <- c(unique(cps$qtr))
```

```{r State analysis function}
#empty lists to store dfs
output_dfs <- list()

state_analysis <- function(quarters){
  for(i in 1:length(qtr_list)){ 
  
  quarterly_laus <- laus %>% 
  filter(qtr==qtr_list[i+1]) %>% 
  group_by(st_abbr) %>%
  summarize(laus_qtr_unemp = mean(urate))  
      
  state_urates <- cps %>% 
  filter(qtr==qtr_list[i] | qtr == qtr_list[i+1]) %>% 
  group_by(st_abbr) %>% 
  summarize(st_urate_6mos = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE))
    
  us_subgroup_urates <- cps %>% 
  filter(qtr==qtr_list[i] | qtr==qtr_list[i+1]) %>% 
  mutate(overall= paste('US','-','All','-','All'),
         gender = paste('US','-','All','-',female),
         race = paste('US','-',wbhao,'-','All'),
         genderXrace = paste('US','-',wbhao,'-',female)) %>% 
  summarize_groups(overall|race|gender|genderXrace,
                   subgroup_urate = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE),
                   n=n()) %>% 
  separate(group_value, c('st_abbr','wbhao','gender')) %>% #creates st_abbr, wbho, gender variables
  mutate(st_urate_6mos = subgroup_urate[1],
         st_abbr = 'US',
         ratio = ifelse(subgroup_urate==0, NA, subgroup_urate/st_urate_6mos))
  
print(paste("Calculating subgroup urates for: ", qtr_list[i+1]))

  all_subgroup_urates<- cps %>% 
    #restrict data to current quarters
    filter(qtr==qtr_list[i] | qtr==qtr_list[i+1]) %>% 
    #create subgroup variables
    mutate(stateXrace = paste(st_abbr,'-', wbhao,'-','All'),
           stateXgender = paste(st_abbr,'-','All','-',female),
           stXraceXgender = paste(st_abbr,'-',wbhao,'-',female)) %>% 
    #Estimate unemployment rates and sample sizes by subgroups
    summarize_groups(st_abbr|stateXrace|stXraceXgender|stateXgender,
                     subgroup_urate = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE),
                     n=n()) %>% 
    #split group_value variable to create st_abbr, wbho, gender labels
    separate(group_value, c('st_abbr','wbhao','gender')) %>% 
    #merge statefips labels by st_abbr to get fips codes and CPS estimated urates
    left_join(state_urates) %>% 
    #get ratio of (6-month state avg:subgroup) unemployment rate
    #NOTE: due to small sample sizes, occasionally subgroups show an unemployment rate of 0%
    #Using ifelse() fcuntion, I avoid using these 0 values as a divisor.
    mutate(ratio = ifelse(subgroup_urate==0, NA, subgroup_urate/st_urate_6mos)) %>% 
    arrange(st_abbr, desc(n)) %>% 
    #bind US unemployment rates
    bind_rows(us_subgroup_urates) %>% 
    #merge quarterly laus unemp estimates
    left_join(quarterly_laus) %>% 
    mutate(qtr_st_urate_by_reg = ratio * laus_qtr_unemp) %>% 
    # replace all values with a coefficient of variation below threshold to NA
    mutate(thresh700 = replace(qtr_st_urate_by_reg, n<700, NA)) %>%
    left_join(state_labels) %>% 
    select(state, st_abbr, gender, wbhao, n, subgroup_urate,
         st_urate_6mos, ratio, laus_qtr_unemp, qtr_st_urate_by_reg, thresh700) %>% # Clean our data up
    mutate(wbhao = replace_na(wbhao, 'All'),
           gender = replace_na(gender, 'All'),
             grp_qtrs = paste(qtr_list[i],'+',qtr_list[i+1]),
             qtr = paste(qtr_list[i+1])) %>% 
  filter(wbhao!='Other')
  
    output_dfs[[i]] <- all_subgroup_urates # save your dataframes into the list
  }
  return(output_dfs)
}
```

```{r State analysis, echo=FALSE}
#call quarterly state function passing all quarters as arguments
my_state_dfs <- state_analysis(qtr_list)
#bind each data frame returned from function
all_qtrs <- bind_rows(my_state_dfs)
```


```{r Final tables}

all_ratios_wide <- all_qtrs %>%
  filter(gender=='All') %>% 
  select(wbhao, thresh700, state, qtr) %>% 
  pivot_wider(names_from=c(wbhao), values_from = thresh700) %>% 
  mutate(bw.ratio = Black/White,
         hw.ratio = Hispanic/White) %>% 
  select(state, qtr, bw.ratio, hw.ratio) %>% 
  filter(qtr!='NA') %>% 
  pivot_wider(id_cols = c(state), names_from = c(qtr), values_from = c(bw.ratio, hw.ratio))

all_ratios_long <- all_qtrs %>%
  filter(gender=='All') %>% 
  select(wbhao, thresh700, state, qtr) %>% 
  pivot_wider(names_from=c(wbhao), values_from = thresh700) %>% 
  mutate(bw.ratio = Black/White,
         hw.ratio = Hispanic/White) %>% 
  select(state, qtr, bw.ratio, hw.ratio) %>% 
  filter(qtr!='NA') %>% 
  arrange(desc(qtr))

```

```{r change since 2020Q1}

change_since_2020q1 <- all_qtrs %>% 
  filter(gender=='All') %>% 
  select(state, wbhao, qtr, thresh700) %>% 
  pivot_wider(id_cols = c(state,wbhao), names_from = qtr, values_from = thresh700) %>% 
  clean_names() %>% 
  select(state, wbhao, x2020_q1:x2022_q1) %>% 
  #subtract all columns by 2020 Q1 column, mult by 100 to get change since 2020 Q1
  mutate(across(x2020_q1:x2022_q1, .fns =  ~(.x - x2020_q1)*100)) %>% 
  pivot_longer(!c(state, wbhao), names_to = 'qtr', values_to = 'change') %>% 
  arrange(qtr) %>% 
  pivot_wider(id_cols = c(state), names_from = c(wbhao,qtr), values_from = change)

urates_wbhao_state <- all_qtrs %>% 
  filter(gender=='All') %>% 
  select(state, wbhao, qtr, thresh700) %>%
  filter(qtr!='NA') %>% 
  arrange(qtr) %>% 
  pivot_wider(id_cols = c(state), names_from = c(wbhao,qtr), values_from = thresh700)

```



Supplemental data

```{r Benchmark of BLS urates}

# df of LAUS monthly urate by state
laus_monthly <- laus %>% 
  select(state, date, urate) %>%
  pivot_wider(id_cols = state, names_from=date, values_from=urate)

# df of LAUS quarterly unemployment by state
laus_qtrly <- laus %>% 
  select(state, qtr, urate) %>% 
  group_by(state, qtr) %>% 
  summarize(qtr_urate = mean(urate)) %>% 
  pivot_wider(id_cols = state, names_from=qtr, values_from=qtr_urate)

# df of CPS monthly urate by state
cps_monthly <- cps %>% 
  group_by(st_abbr, date) %>% 
  summarize(urate = weighted.mean(unemp, w=basicwgt/6)) %>%
  pivot_wider(id_cols = st_abbr, names_from=date, values_from = urate)

# df of CPS auarterly urate by state
cps_qtrly <- cps %>% 
  group_by(st_abbr, qtr) %>% 
  summarize(urate = weighted.mean(unemp, w=basicwgt/6)) %>%
  pivot_wider(id_cols = st_abbr, names_from=qtr, values_from = urate) 

```

```{r Workbook export}

pct = createStyle(numFmt = '0.0%')
ppt = createStyle(numFmt = '0.0')
ppt2 = createStyle(numFmt = '0.00')

acct = createStyle(numFmt = '#,#0' )
currency = createStyle(numFmt = '$#,#0') 

hs1 <- createStyle(fgFill = "#bfbfbf", halign = "CENTER", textDecoration = "Bold",
                   border = "Bottom", fontColour = "black")

EARN_staterace_umemp <- createWorkbook()


addWorksheet(EARN_staterace_umemp, sheetName = 'State urates')
addWorksheet(EARN_staterace_umemp, sheetName = 'Change since 2020 Q1')
addWorksheet(EARN_staterace_umemp, sheetName = 'Ratios long')
addWorksheet(EARN_staterace_umemp, sheetName = 'Ratios wide')
addWorksheet(EARN_staterace_umemp, sheetName = 'All raw data')

addWorksheet(EARN_staterace_umemp, sheetName = "LAUS Monthly")
addWorksheet(EARN_staterace_umemp, sheetName = "LAUS Qtrly")
addWorksheet(EARN_staterace_umemp, sheetName = "CPS Monthly")
addWorksheet(EARN_staterace_umemp, sheetName = "CPS Qtrly")


writeData(EARN_staterace_umemp, headerStyle = hs1, urates_wbhao_state, sheet = 'State urates',
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, headerStyle = hs1, change_since_2020q1, sheet = 'Change since 2020 Q1',
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, headerStyle = hs1, all_ratios_long, sheet = 'Ratios long',
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, headerStyle = hs1, all_ratios_wide, sheet = 'Ratios wide',
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, headerStyle = hs1, all_qtrs, sheet = 'All raw data',
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)

writeData(EARN_staterace_umemp, headerStyle = hs1, laus_monthly, sheet = "LAUS Monthly",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, headerStyle = hs1, laus_qtrly, sheet = "LAUS Qtrly",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, headerStyle = hs1, cps_qtrly, sheet = "CPS Qtrly",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, headerStyle = hs1, cps_monthly , sheet = "CPS Monthly",
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)

#add ppt format
addStyle(EARN_staterace_umemp, 'Change since 2020 Q1', style=ppt, cols=c(2:46), rows=2:(nrow(change_since_2020q1)+1), gridExpand=TRUE)

addStyle(EARN_staterace_umemp, 'Ratios wide', style=ppt2, cols=c(2:46), rows=2:(nrow(all_ratios_wide)+1), gridExpand=TRUE)
addStyle(EARN_staterace_umemp, 'Ratios long', style=ppt2, cols=c(3,4), rows=2:(nrow(all_ratios_long)+1), gridExpand=TRUE)


#add pct format
addStyle(EARN_staterace_umemp, 'State urates', style=pct, cols=c(2:121), rows=2:(nrow(current_urates)+1), gridExpand=TRUE)

addStyle(EARN_staterace_umemp, "LAUS Monthly", style=pct, cols=c(2:ncol(laus_monthly)), rows=2:(nrow(laus_monthly)+1), gridExpand=TRUE)
addStyle(EARN_staterace_umemp, "LAUS Qtrly", style=pct, cols=c(2:ncol(laus_qtrly)), rows=2:(nrow(laus_qtrly)+1), gridExpand=TRUE)
addStyle(EARN_staterace_umemp, "CPS Monthly", style=pct, cols=c(2:ncol(cps_qtrly)), rows=2:(nrow(cps_qtrly)+1), gridExpand=TRUE)
addStyle(EARN_staterace_umemp, "CPS Qtrly", style=pct, cols=c(2:ncol(cps_monthly)), rows=2:(nrow(cps_monthly)+1), gridExpand=TRUE)

#set column widths
setColWidths(EARN_staterace_umemp, 'State urates', cols = 2:ncol(urates_wbhao_state), widths = "auto")
setColWidths(EARN_staterace_umemp, 'Change since 2020 Q1', cols = 2:ncol(change_since_2020q1), widths = "auto")
setColWidths(EARN_staterace_umemp, 'Ratios long', cols = 2:ncol(all_ratios_long), widths = "auto")
setColWidths(EARN_staterace_umemp, 'Ratios wide', cols = 2:ncol(all_ratios_wide), widths = "auto")
setColWidths(EARN_staterace_umemp, 'All raw data', cols = 2:ncol(all_qtrs), widths = "auto")


setColWidths(EARN_staterace_umemp, "LAUS Monthly", cols = 2:ncol(laus_monthly), widths = "auto")
setColWidths(EARN_staterace_umemp, "LAUS Qtrly", cols = 2:ncol(laus_qtrly), widths = "auto")
setColWidths(EARN_staterace_umemp, "CPS Qtrly", cols = 2:ncol(cps_qtrly), widths = "auto")
setColWidths(EARN_staterace_umemp, "CPS Monthly", cols = 2:ncol(cps_monthly), widths = "auto")

saveWorkbook(EARN_staterace_umemp, here(paste0('data/EARN_staterace_.xlsx')), overwrite = TRUE)
```




