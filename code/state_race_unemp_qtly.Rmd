---
title: "state_race_unemp_qtly"
author: Daniel Perez, EPI
output: html_document
---

```{r Libraries}
library(tidyverse)
library(epiextractr)
library(epidatatools)
library(blsAPI)
library(here)
library(readxl)
library(openxlsx)
library(data.table)
library(zoo)
library(lubridate)
library(ggplot2)

```


```{r BLS API function}

#BLS API keys are available at https://www.bls.gov/developers/
bls_key <- Sys.getenv("BLS_REG_KEY")
series_ids <- fread(here('input/seriesid.csv'))
statedata <- series_ids$series_id

# This is where our state unemployment data lives
rawsource <- "https://download.bls.gov/pub/time.series/la/"

#function to retrieve data from BLS
#max number of years is 20 per query, max seriesids is 50 per query, max queries per day is 500 for registered users.
get_bls_data <- function(codes) {
  
  payload1 <- list('seriesid' = codes[1:50], 'startyear' = '2006', 'endyear' = '2021', 'registrationkey' = bls_key)
  payload2 <- list('seriesid' = codes[51:52], 'startyear' = '2006', 'endyear' = '2021', 'registrationkey' = bls_key)

  df1 <- blsAPI(payload1, api_version = 2, return_data_frame = TRUE)
  df2 <- blsAPI(payload2, api_version = 2, return_data_frame = TRUE)
  
  rbind(df1, df2)
}

```


Load LAUS data, and state labels here

```{r Load LAUS via BLS API}
#Optional -- load state labels
state_labels<- read_csv(here('input/statefips_labels.csv'), col_names = TRUE)

# Clean and format bls data
laus <- get_bls_data(statedata) %>% 
  #convert LAUS urates into percentages
  mutate(urate = as.numeric(value)/100, .keep="unused") %>% 
  #merge state names by series ID
  full_join(series_ids, by= c('seriesID' = 'series_id')) %>%
  #create standard date variable
  mutate(month = as.numeric(substr(period,2,3))) %>% 
  mutate(date = as.Date(paste(year, month, 1, sep = "-"), "%Y-%m-%d")) %>% 
  #create quarterly variable 
  mutate(qtr=as.yearqtr(date)) %>% 
  arrange(year, month, state) %>% 
  #merge state labels (optional)
  left_join(state_labels)

```


```{r Load CPS via EPI extractr}
#Use EPI extractr to load CPS Basic. See more at https://github.com/Economic/epiextractr
cps <-load_basic(2012:2021, year, month, basicwgt, age, female, wbhao, statefips, division, unemp, lfstat) %>% 
  filter(age>=16, lfstat %in% c(1,2)) %>% 
  mutate(date = as.Date(paste(year, month, 1, sep = "-"), "%Y-%m-%d")) %>% 
  #create quarterly date periods
  mutate(qtr=as.yearqtr(date)) %>%  
  #merge optional labels
  left_join(state_labels) %>% 
  mutate(across(wbhao|female, ~ as.character(haven::as_factor(.x))))
```

```{r Quarterly analysis function}

#empty lists to store dfs
output_dfs <- list()

qtly_analysis <- function(quarters){

  for(i in 1:length(qtr_list)){ 
  
  quarterly_laus <- laus %>% 
  filter(qtr==qtr_list[i+1]) %>% 
  group_by(st_abbr) %>%
  summarize(laus_qtr_unemp = mean(urate))  
      
  state_urates <- cps %>% 
  filter(qtr==qtr_list[i] | qtr == qtr_list[i+1]) %>% 
  group_by(st_abbr) %>% 
  summarize(st_urate_6mos = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE))
    
  us_subgroup_urates <- cps %>% 
  filter(qtr==qtr_list[i] | qtr==qtr_list[i+1]) %>% 
  mutate(overall= paste('US','-','All','-','All'),
         gender = paste('US','-','All','-',female),
         race = paste('US','-',wbhao,'-','All'),
         genderXrace = paste('US','-',wbhao,'-',female)) %>% 
  summarize_groups(overall|race|gender|genderXrace,
                   subgroup_urate = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE),
                   n=n()) %>% 
  separate(group_value, c('st_abbr','wbhao','gender')) %>% #creates st_abbr, wbho, gender variables
  mutate(st_urate_6mos = subgroup_urate[1],
         st_abbr = 'US',
         ratio = ifelse(subgroup_urate==0, NA, subgroup_urate/st_urate_6mos))

  all_subgroup_urates<- cps %>% 
    #restrict data to current quarters
    filter(qtr==qtr_list[i] | qtr==qtr_list[i+1]) %>% 
    #create subgroup variables
    mutate(stateXrace = paste(st_abbr,'-', wbhao,'-','All'),
           stateXgender = paste(st_abbr,'-','All','-',female),
           stXraceXgender = paste(st_abbr,'-',wbhao,'-',female)) %>% 
    #Estimate unemployment rates and sample sizes by subgroups
    summarize_groups(st_abbr|stateXrace|stXraceXgender|stateXgender,
                     subgroup_urate = weighted.mean(unemp, w=basicwgt/6, na.rm=TRUE),
                     n=n()) %>% 
    #split group_value variable to create st_abbr, wbho, gender labels
    separate(group_value, c('st_abbr','wbhao','gender')) %>% 
    #merge statefips labels by st_abbr to get fips codes and CPS estimated urates
    left_join(state_urates) %>% 
    #get ratio of (6-month state avg:subgroup) unemployment rate
    #NOTE: due to small sample sizes, occasionally subgroups show an unemployment rate of 0%
    #Using ifelse() fcuntion, I avoid using these 0 values as a divisor.
    mutate(ratio = ifelse(subgroup_urate==0, NA, subgroup_urate/st_urate_6mos)) %>% 
    arrange(st_abbr, desc(n)) %>% 
    #bind US unemployment rates
    bind_rows(us_subgroup_urates) %>% 
    #merge quarterly laus unemp estimates
    left_join(quarterly_laus) %>% 
    mutate(qtr_st_urate_by_reg = ratio * laus_qtr_unemp,
           se = ifelse(subgroup_urate==0, NA, sqrt(subgroup_urate*(1-subgroup_urate)/n)),
           cv = ifelse(subgroup_urate==0, NA, se / subgroup_urate)) %>% 
    # replace all values with a coefficient of variation below threshold to NA
    mutate(thresh.10 = replace(qtr_st_urate_by_reg, cv>.10, NA),
           thresh.15 = replace(qtr_st_urate_by_reg, cv>.15, NA),
           thresh.20 = replace(qtr_st_urate_by_reg, cv>.20, NA),
           thresh.25 = replace(qtr_st_urate_by_reg, cv>.25, NA)) %>%  
    left_join(state_labels) %>% 
    select(state, st_abbr, gender, wbhao, n, subgroup_urate,
           st_urate_6mos, ratio, laus_qtr_unemp, qtr_st_urate_by_reg,
           se, cv, thresh.10:thresh.25) %>% # Clean our data up
      mutate(wbhao = replace_na(wbhao, 'All'),
             gender = replace_na(gender, 'All'),
             grp_qtrs = paste(qtr_list[i],'+',qtr_list[i+1]),
             qtr = paste(qtr_list[i+1])) %>% 
    filter(wbhao!='Other')
  
    output_dfs[[i]] <- all_subgroup_urates # save your dataframes into the list

  }
  return(output_dfs)
}

```

```{r Desired quarters, echo=FALSE}

qtr_list <- c(unique(cps$qtr))

my_dfs <- qtly_analysis(qtr_list)

all_qtrs <- bind_rows(my_dfs)

```

```{r}
counts <- all_qtrs %>% 
  filter(gender=='All', wbhao!='All') %>% 
  group_by(wbhao) %>% 
  summarize(thresh.10 = colSums(!is.na(thresh.10)))# %>% 
  pivot_wider(id_cols = qtr, names_from = wbhao, values_from = thresh.10)
  

```



```{r Unsuppressed analysis}

ref_qtr <- all_qtrs %>% 
  filter(qtr=='2020 Q1')

state_urates <- all_qtrs %>% 
  filter(gender == 'All', wbhao!='All') %>% 
  select(qtr, state, wbhao, qtr_st_urate_by_reg) %>%
  arrange(wbhao) %>% 
  pivot_wider(id_cols = c(qtr), names_from = c(state, wbhao), values_from = qtr_st_urate_by_reg) %>%
  filter(qtr!='NA') %>% 
  write_csv(here(paste0('data/state_urates_',format(Sys.time(), "%d-%b-%Y %H.%M"),'.csv')))

unsupressed_urate_count <- all_qtrs %>% 
  filter(gender == 'All', wbhao!='All') %>% 
  select(qtr, state, wbhao, thresh.10:thresh.25) %>%
  pivot_longer(cols = c(thresh.10:thresh.25), names_to = "threshold", values_to = 'urates') %>% 
  group_by(wbhao, threshold) %>% 
  summarize(supressed = sum(!is.na(urates))) %>% 
  pivot_wider(id_cols = c(wbhao), names_from = c(threshold), values_from = supressed)

unsupressed_by_st <- all_qtrs %>% 
  filter(gender == 'All', wbhao!='All') %>% 
  select(qtr, state, wbhao, thresh.10:thresh.25) %>%
  pivot_longer(cols = c(thresh.10:thresh.25), names_to = "threshold", values_to = 'urates') %>% 
  group_by(wbhao, state, threshold) %>% 
  summarize(supressed = sum(!is.na(urates))) %>% 
  pivot_wider(id_cols = c(state), names_from = c(wbhao,threshold), values_from = supressed) %>% 
  write_csv(here(paste0("data/39qtr_state_urates_", format(Sys.time(), "%d-%b-%Y %H.%M"), ".csv")))


```


```{r Final tables}
#Unemployment rate maps/tables
current_urates <- current_quarter_output %>% 
  filter(gender=='All') %>% 
  pivot_wider(id_cols=state, names_from = wbhao, values_from = c(thresh.25:thresh.10), names_prefix = 'c_')
  
reference_urates <- reference_quarter_output %>% 
  filter(gender=='All') %>% 
  pivot_wider(id_cols=state, names_from = wbhao, values_from = c(thresh.25:thresh.10), names_prefix = 'r_')

#Uemployment ratio tables
current_qtr_ratios_table <- current_urates %>% 
  mutate(c_bw_ratio = thresh.25_c_Black/thresh.25_c_White,
         c_hw_ratio = thresh.25_c_Hispanic/thresh.25_c_White) %>% 
  select(state, c_bw_ratio, c_hw_ratio)

reference_qtr_ratios_table <- reference_urates %>% 
  mutate(r_bw_ratio = thresh.25_r_Black/thresh.25_r_White,
         r_hw_ratio = thresh.25_r_Hispanic/thresh.25_r_White) %>% 
  select(state, r_bw_ratio, r_hw_ratio)

#Ppt change between reference and current periods
change_since_previous_period <- current_urates %>% 
  left_join(reference_urates, by='state') %>% 
  mutate(d_All = (thresh.25_c_All - thresh.25_r_All)*100,
         d_White = (thresh.25_c_White - thresh.25_r_White)*100,
         d_Black = (thresh.25_c_Black - thresh.25_r_Black)*100,
         d_Hispanic = (thresh.25_c_Hispanic - thresh.25_r_Hispanic)*100,
         d_AAPI = (thresh.25_c_Asian - thresh.25_r_Asian)*100) %>% 
  select(state,contains('d_'))

```

Supplemental data

```{r Benchmark of BLS urates}

# df of LAUS monthly urate by state
laus_monthly <- laus %>% 
  select(state, date, urate) %>%
  pivot_wider(id_cols = state, names_from=date, values_from=urate)

# df of LAUS quarterly unemployment by state
laus_qtrly <- laus %>% 
  select(state, qtr, urate) %>% 
  group_by(state, qtr) %>% 
  summarize(qtr_urate = mean(urate)) %>% 
  pivot_wider(id_cols = state, names_from=qtr, values_from=qtr_urate)

# df of CPS monthly urate by state
cps_monthly <- cps %>% 
  group_by(st_abbr, date) %>% 
  summarize(urate = weighted.mean(unemp, w=basicwgt/6)) %>%
  pivot_wider(id_cols = st_abbr, names_from=date, values_from = urate)

# df of CPS auarterly urate by state
cps_qtrly <- cps %>% 
  group_by(st_abbr, qtr) %>% 
  summarize(urate = weighted.mean(unemp, w=basicwgt/6)) %>%
  pivot_wider(id_cols = st_abbr, names_from=qtr, values_from = urate) 

```

```{r Workbook export}

pct = createStyle(numFmt = '0.0%')
ppt = createStyle(numFmt = '0.0')

acct = createStyle(numFmt = '#,#0' )
currency = createStyle(numFmt = '$#,#0') 
hs1 <- createStyle(fgFill = "#bfbfbf", halign = "CENTER", textDecoration = "Bold",
                   border = "Bottom", fontColour = "black")

EARN_staterace_umemp <- createWorkbook()


addWorksheet(EARN_staterace_umemp, sheetName = paste0(cur_qtr, ' raw'))
addWorksheet(EARN_staterace_umemp, sheetName = paste0(ref_qtr2, ' raw'))
addWorksheet(EARN_staterace_umemp, sheetName = paste0(cur_qtr, ' Urates'))
# addWorksheet(EARN_staterace_umemp, sheetName = paste0(ref_qtr2, ' Urates'))
# addWorksheet(EARN_staterace_umemp, sheetName = paste0(cur_qtr, ' BW HW ratios'))
# addWorksheet(EARN_staterace_umemp, sheetName = paste0(ref_qtr2,' BW HW ratios'))
# addWorksheet(EARN_staterace_umemp, sheetName = paste0(cur_qtr,' vs ', ref_qtr2))
# addWorksheet(EARN_staterace_umemp, sheetName = "LAUS Monthly")
# addWorksheet(EARN_staterace_umemp, sheetName = "LAUS Qtrly")
# addWorksheet(EARN_staterace_umemp, sheetName = "CPS Monthly")
# addWorksheet(EARN_staterace_umemp, sheetName = "CPS Qtrly")


writeData(EARN_staterace_umemp, headerStyle = hs1, current_quarter_output, sheet = paste0(cur_qtr, ' raw'),
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, headerStyle = hs1, reference_quarter_output, sheet = paste0(ref_qtr2, ' raw'),
           startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
writeData(EARN_staterace_umemp, headerStyle = hs1, current_urates, sheet = paste0(cur_qtr, ' Urates'),
          startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
# writeData(EARN_staterace_umemp, headerStyle = hs1, reference_urates, sheet = paste0(ref_qtr2, ' Urates'),
#           startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
# writeData(EARN_staterace_umemp, headerStyle = hs1, current_qtr_ratios_table, sheet = paste0(cur_qtr, ' BW HW ratios'),
#           startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
# writeData(EARN_staterace_umemp, headerStyle = hs1, reference_qtr_ratios_table , sheet = paste0(ref_qtr2,' BW HW ratios'),
#           startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
# writeData(EARN_staterace_umemp, headerStyle = hs1, change_since_previous_period , sheet = paste0(cur_qtr,' vs ', ref_qtr2),
#           startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
# writeData(EARN_staterace_umemp, headerStyle = hs1, laus_monthly, sheet = "LAUS Monthly",
#           startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
# writeData(EARN_staterace_umemp, headerStyle = hs1, laus_qtrly, sheet = "LAUS Qtrly",
#           startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
# writeData(EARN_staterace_umemp, headerStyle = hs1, cps_qtrly, sheet = "CPS Qtrly",
#           startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
# writeData(EARN_staterace_umemp, headerStyle = hs1, cps_monthly , sheet = "CPS Monthly",
#           startCol = 1, startRow = 1, colNames = TRUE, keepNA = TRUE)
# 
# #add ppt format
#addStyle(EARN_staterace_umemp, paste0(cur_qtr, ' BW HW ratios'), style=ppt, cols=c(2:3), rows=2:(nrow(current_qtr_ratios_table)+1), gridExpand=TRUE)
# addStyle(EARN_staterace_umemp, paste0(ref_qtr2,' BW HW ratios'), style=ppt, cols=c(2:3), rows=2:(nrow(reference_qtr_ratios_table)+1), gridExpand=TRUE)
# addStyle(EARN_staterace_umemp, paste0(cur_qtr,' vs ', ref_qtr2), style=ppt, cols=c(2:6), rows=2:(nrow(change_since_previous_period)+1), gridExpand=TRUE)

#add pct format
addStyle(EARN_staterace_umemp, paste0(cur_qtr, ' Urates'), style=pct, cols=c(2:6), rows=2:(nrow(current_urates)+1), gridExpand=TRUE)
# addStyle(EARN_staterace_umemp, paste0(ref_qtr2, ' Urates'), style=pct, cols=c(2:6), rows=2:(nrow(reference_urates)+1), gridExpand=TRUE)
# addStyle(EARN_staterace_umemp, "LAUS Monthly", style=pct, cols=c(2:ncol(laus_monthly)), rows=2:(nrow(laus_monthly)+1), gridExpand=TRUE)
# addStyle(EARN_staterace_umemp, "LAUS Qtrly", style=pct, cols=c(2:ncol(laus_qtrly)), rows=2:(nrow(laus_qtrly)+1), gridExpand=TRUE)
# addStyle(EARN_staterace_umemp, "CPS Monthly", style=pct, cols=c(2:ncol(cps_qtrly)), rows=2:(nrow(cps_qtrly)+1), gridExpand=TRUE)
# addStyle(EARN_staterace_umemp, "CPS Qtrly", style=pct, cols=c(2:ncol(cps_monthly)), rows=2:(nrow(cps_monthly)+1), gridExpand=TRUE)

#set column widths
setColWidths(EARN_staterace_umemp, paste0(cur_qtr, ' Urates'), cols = 2:ncol(current_urates), widths = "auto")
#setColWidths(EARN_staterace_umemp, paste0(ref_qtr2, ' Urates'), cols = 2:ncol(reference_urates), widths = "auto")
# setColWidths(EARN_staterace_umemp, paste0(cur_qtr, ' BW HW ratios'), cols = 2:ncol(current_qtr_ratios_table), widths = "auto")
# setColWidths(EARN_staterace_umemp, paste0(ref_qtr2,' BW HW ratios'), cols = 2:ncol(reference_qtr_ratios_table), widths = "auto")
# setColWidths(EARN_staterace_umemp, paste0(cur_qtr,' vs ', ref_qtr2), cols = 2:ncol(change_since_previous_period), widths = "auto")
# setColWidths(EARN_staterace_umemp, "LAUS Monthly", cols = 2:ncol(laus_monthly), widths = "auto")
# setColWidths(EARN_staterace_umemp, "LAUS Qtrly", cols = 2:ncol(laus_qtrly), widths = "auto")
# setColWidths(EARN_staterace_umemp, "CPS Qtrly", cols = 2:ncol(cps_qtrly), widths = "auto")
# setColWidths(EARN_staterace_umemp, "CPS Monthly", cols = 2:ncol(cps_monthly), widths = "auto")

saveWorkbook(EARN_staterace_umemp, here(paste0('data/EARN_staterace_',cur_qtr,'.xlsx')), overwrite = TRUE)
```




